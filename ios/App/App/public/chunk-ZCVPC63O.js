import{A as F,B as Z,F as $,G as j,H as q,K as G,M as P,N as ee,e as U,q as x,y as w,z as Q}from"./chunk-42PVXCFM.js";import{t as H,u as te}from"./chunk-VQCHUAXV.js";import{D as _,Y as m,hb as D,jb as R,nb as M,z as L}from"./chunk-DHHGUDQP.js";import{f as E,o as d}from"./chunk-FIPIWZQS.js";function X(e,t){let r={};for(let n in e)e.hasOwnProperty(n)&&(r[n]=t(e[n]));return r}function S(e){if(e==null)return null;if(e instanceof Number&&(e=e.valueOf()),typeof e=="number"&&isFinite(e)||e===!0||e===!1||Object.prototype.toString.call(e)==="[object String]")return e;if(e instanceof Date)return e.toISOString();if(Array.isArray(e))return e.map(t=>S(t));if(typeof e=="function"||typeof e=="object")return X(e,t=>S(t));throw new Error("Data cannot be encoded in JSON: "+e)}function y(e){if(e==null)return e;if(e["@type"])switch(e["@type"]){case ne:case re:{let t=Number(e.value);if(isNaN(t))throw new Error("Data cannot be decoded from JSON: "+e);return t}default:throw new Error("Data cannot be decoded from JSON: "+e)}return Array.isArray(e)?e.map(t=>y(t)):typeof e=="function"||typeof e=="object"?X(e,t=>y(t)):e}function oe(e){if(e>=200&&e<300)return"ok";switch(e){case 0:return"internal";case 400:return"invalid-argument";case 401:return"unauthenticated";case 403:return"permission-denied";case 404:return"not-found";case 409:return"aborted";case 429:return"resource-exhausted";case 499:return"cancelled";case 500:return"internal";case 501:return"unimplemented";case 503:return"unavailable";case 504:return"deadline-exceeded"}return"unknown"}function T(e,t){let r=oe(e),n=r,o;try{let i=t&&t.error;if(i){let a=i.status;if(typeof a=="string"){if(!J[a])return new f("internal","internal");r=J[a],n=a}let s=i.message;typeof s=="string"&&(n=s),o=i.details,o!==void 0&&(o=y(o))}}catch{}return r==="ok"?null:new f(r,n,o)}function se(e){let t=null;return{promise:new Promise((r,n)=>{t=setTimeout(()=>{n(new f("deadline-exceeded","deadline-exceeded"))},e)}),cancel:()=>{t&&clearTimeout(t)}}}function ae(e,t,r){e.emulatorOrigin=`http://${t}:${r}`}function ce(e,t,r){let n=o=>le(e,t,o,r||{});return n.stream=(o,i)=>fe(e,t,o,i),n}function ue(e,t,r,n){return d(this,null,function*(){r["Content-Type"]="application/json";let o;try{o=yield n(e,{method:"POST",body:JSON.stringify(t),headers:r})}catch{return{status:0,json:null}}let i=null;try{i=yield o.json()}catch{}return{status:o.status,json:i}})}function Y(e,t){return d(this,null,function*(){let r={},n=yield e.contextProvider.getContext(t.limitedUseAppCheckTokens);return n.authToken&&(r.Authorization="Bearer "+n.authToken),n.messagingToken&&(r["Firebase-Instance-ID-Token"]=n.messagingToken),n.appCheckToken!==null&&(r["X-Firebase-AppCheck"]=n.appCheckToken),r})}function le(e,t,r,n){let o=e._url(t);return de(e,o,r,n)}function de(e,t,r,n){return d(this,null,function*(){r=S(r);let o={data:r},i=yield Y(e,n),a=n.timeout||7e4,s=se(a),u=yield Promise.race([ue(t,o,i,e.fetchImpl),s.promise,e.cancelAllRequests]);if(s.cancel(),!u)throw new f("cancelled","Firebase Functions instance was deleted.");let l=T(u.status,u.json);if(l)throw l;if(!u.json)throw new f("internal","Response is not valid JSON object.");let c=u.json.data;if(typeof c>"u"&&(c=u.json.result),typeof c>"u")throw new f("internal","Response is missing data field.");return{data:y(c)}})}function fe(e,t,r,n){let o=e._url(t);return he(e,o,r,n||{})}function he(e,t,r,n){return d(this,null,function*(){var o;r=S(r);let i={data:r},a=yield Y(e,n);a["Content-Type"]="application/json",a.Accept="text/event-stream";let s;try{s=yield e.fetchImpl(t,{method:"POST",body:JSON.stringify(i),headers:a,signal:n==null?void 0:n.signal})}catch(h){if(h instanceof Error&&h.name==="AbortError"){let A=new f("cancelled","Request was cancelled.");return{data:Promise.reject(A),stream:{[Symbol.asyncIterator](){return{next(){return Promise.reject(A)}}}}}}let k=T(0,null);return{data:Promise.reject(k),stream:{[Symbol.asyncIterator](){return{next(){return Promise.reject(k)}}}}}}let u,l,c=new Promise((h,k)=>{u=h,l=k});(o=n==null?void 0:n.signal)===null||o===void 0||o.addEventListener("abort",()=>{let h=new f("cancelled","Request was cancelled.");l(h)});let p=s.body.getReader(),g=pe(p,u,l,n==null?void 0:n.signal);return{stream:{[Symbol.asyncIterator](){let h=g.getReader();return{next(){return d(this,null,function*(){let{value:A,done:W}=yield h.read();return{value:A,done:W}})},return(){return d(this,null,function*(){return yield h.cancel(),{done:!0,value:void 0}})}}}},data:c}})}function pe(e,t,r,n){let o=(a,s)=>{let u=a.match(ie);if(!u)return;let l=u[1];try{let c=JSON.parse(l);if("result"in c){t(y(c.result));return}if("message"in c){s.enqueue(y(c.message));return}if("error"in c){let p=T(0,c);s.error(p),r(p);return}}catch(c){if(c instanceof f){s.error(c),r(c);return}}},i=new TextDecoder;return new ReadableStream({start(a){let s="";return u();function u(){return d(this,null,function*(){if(n!=null&&n.aborted){let l=new f("cancelled","Request was cancelled");return a.error(l),r(l),Promise.resolve()}try{let{value:l,done:c}=yield e.read();if(c){s.trim()&&o(s.trim(),a),a.close();return}if(n!=null&&n.aborted){let g=new f("cancelled","Request was cancelled");a.error(g),r(g),yield e.cancel();return}s+=i.decode(l,{stream:!0});let p=s.split(`
`);s=p.pop()||"";for(let g of p)g.trim()&&o(g.trim(),a);return u()}catch(l){let c=l instanceof f?l:T(0,null);a.error(c),r(c)}})}},cancel(){return e.cancel()}})}function ke(e){let t=(r,{instanceIdentifier:n})=>{let o=r.getProvider("app").getImmediate(),i=r.getProvider(ge),a=r.getProvider(ye),s=r.getProvider(me);return new C(o,i,a,s,n)};$(new F(O,t,"PUBLIC").setMultipleInstances(!0)),P(V,B,e),P(V,B,"esm2017")}function b(e=G(),t=I){let n=j(w(e),O).getImmediate({identifier:t}),o=U("functions");return o&&Ae(n,...o),n}function Ae(e,t,r){ae(w(e),t,r)}function v(e,t,r){return ce(w(e),t,r)}var ne,re,O,J,f,N,I,ie,C,V,B,ge,me,ye,K=E(()=>{"use strict";ee();Q();Z();ne="type.googleapis.com/google.protobuf.Int64Value",re="type.googleapis.com/google.protobuf.UInt64Value";O="functions";J={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},f=class e extends x{constructor(t,r,n){super(`${O}/${t}`,r||""),this.details=n,Object.setPrototypeOf(this,e.prototype)}};N=class{constructor(t,r,n,o){this.app=t,this.auth=null,this.messaging=null,this.appCheck=null,this.serverAppAppCheckToken=null,q(t)&&t.settings.appCheckToken&&(this.serverAppAppCheckToken=t.settings.appCheckToken),this.auth=r.getImmediate({optional:!0}),this.messaging=n.getImmediate({optional:!0}),this.auth||r.get().then(i=>this.auth=i,()=>{}),this.messaging||n.get().then(i=>this.messaging=i,()=>{}),this.appCheck||o==null||o.get().then(i=>this.appCheck=i,()=>{})}getAuthToken(){return d(this,null,function*(){if(this.auth)try{let t=yield this.auth.getToken();return t==null?void 0:t.accessToken}catch{return}})}getMessagingToken(){return d(this,null,function*(){if(!(!this.messaging||!("Notification"in self)||Notification.permission!=="granted"))try{return yield this.messaging.getToken()}catch{return}})}getAppCheckToken(t){return d(this,null,function*(){if(this.serverAppAppCheckToken)return this.serverAppAppCheckToken;if(this.appCheck){let r=t?yield this.appCheck.getLimitedUseToken():yield this.appCheck.getToken();return r.error?null:r.token}return null})}getContext(t){return d(this,null,function*(){let r=yield this.getAuthToken(),n=yield this.getMessagingToken(),o=yield this.getAppCheckToken(t);return{authToken:r,messagingToken:n,appCheckToken:o}})}};I="us-central1",ie=/^data: (.*?)(?:\n|$)/;C=class{constructor(t,r,n,o,i=I,a=(...s)=>fetch(...s)){this.app=t,this.fetchImpl=a,this.emulatorOrigin=null,this.contextProvider=new N(t,r,n,o),this.cancelAllRequests=new Promise(s=>{this.deleteService=()=>Promise.resolve(s())});try{let s=new URL(i);this.customDomain=s.origin+(s.pathname==="/"?"":s.pathname),this.region=I}catch{this.customDomain=null,this.region=i}}_delete(){return this.deleteService()}_url(t){let r=this.app.options.projectId;return this.emulatorOrigin!==null?`${this.emulatorOrigin}/${r}/${this.region}/${t}`:this.customDomain!==null?`${this.customDomain}/${t}`:`https://${this.region}-${r}.cloudfunctions.net/${t}`}};V="@firebase/functions",B="0.12.3";ge="auth-internal",me="app-check-internal",ye="messaging-internal";ke()});var z=E(()=>{"use strict";K()});var De,we=E(()=>{"use strict";M();z();te();M();De=(()=>{let t=class t{constructor(){this.authService=_(H),this.accountActive=R(()=>(this.authService.authState().isAuthenticated,!1)),this.onboardingLink=m(null),this.loadingAccountStatus=m(!0),this.loadingOnboardingLink=m(!1),this.loadingPaymentIntent=m(!1),this.loadingPaymentConfirmation=m(!1),this.errorMessage=m(""),this.stripeState=D(()=>({accountActive:this.accountActive(),onboardingLink:this.onboardingLink(),loading:{accountStatus:this.loadingAccountStatus(),onboardingLink:this.loadingOnboardingLink(),paymentIntent:this.loadingPaymentIntent(),paymentConfirmation:this.loadingPaymentConfirmation()},errorMessage:this.errorMessage()}))}getStripeAccountStatus(){return d(this,null,function*(){var n;console.log("setting loading accouint status true"),this.loadingAccountStatus.set(!0);try{console.log("calling getStripeAccountStatus");let o=b(),a=yield v(o,"checkStripeAccountStatus")();this.errorMessage.set(""),this.accountActive.set((n=a.data)==null?void 0:n.isActive)}catch(o){console.error("Stripe account check failed:",o),this.errorMessage.set("Error al comprobar el estado de la cuenta de Stripe")}finally{this.loadingAccountStatus.set(!1)}})}getStripeOnboardingLink(){return d(this,null,function*(){this.loadingOnboardingLink.set(!0);try{let n=b(),i=yield v(n,"createStripeOnboardingLink")();this.errorMessage.set(""),this.onboardingLink.set(i.data.url),console.log({linkResult:i.data})}catch(n){console.error("Stripe account check failed:",n),this.errorMessage.set("Error al generar el enlace de activaci\xF3n de Stripe")}this.loadingOnboardingLink.set(!1)})}createPaymentIntent(a){return d(this,arguments,function*({totalAmount:n,currency:o="eur",sellerStripeId:i}){this.loadingPaymentIntent.set(!0);try{let s=b(),l=yield v(s,"createPaymentIntent")({amount:n,currency:o,sellerStripeId:i});return console.log({paymentIntentResult:l}),l.data}catch(s){console.error("Stripe payment intent creation failed:",s),this.errorMessage.set("Error al crear el pago con Stripe")}return this.loadingPaymentIntent.set(!1),null})}confirmPayment(s){return d(this,arguments,function*({stripeInstance:n,clientSecret:o,stripeCard:i,cardName:a}){var p,g,h;if(!n)return null;let u=yield n==null?void 0:n.confirmCardPayment(o,{payment_method:{card:i,billing_details:{name:a!=null?a:(p=this.authService.currentUser())==null?void 0:p.fullName}}});console.log({result:u}),u||this.errorMessage.set("Error al confirmar el pago"),u.error&&this.errorMessage.set((g=u.error.message)!=null?g:"Error al confirmar el pago");let l={canceled:"Pago cancelado",processing:"Pago en proceso",requires_action:"Pago pendiente de aprobaci\xF3n",requires_capture:"Pago pendiente de captura",requires_confirmation:"Pago pendiente de confirmaci\xF3n",requires_payment_method:"Pago pendiente de pago con tarjeta"},c=(h=u.paymentIntent)==null?void 0:h.status;return c&&l[c]&&this.errorMessage.set(l[c]),u})}};t.\u0275fac=function(o){return new(o||t)},t.\u0275prov=L({token:t,factory:t.\u0275fac,providedIn:"root"});let e=t;return e})()});export{b as a,v as b,z as c,De as d,we as e};
