import{a as Pt,b as jt}from"./chunk-7HX7VADE.js";import{a as vt,b as Lt,e as bt,f as Rt}from"./chunk-2GV3WWDM.js";import"./chunk-QZLDCAKT.js";import"./chunk-7QGFDW3N.js";import"./chunk-CVZVN4BI.js";import"./chunk-6RPMLJXL.js";import"./chunk-ZDSPE5PQ.js";import"./chunk-XV6JN3SG.js";import"./chunk-G3RFF6YC.js";import"./chunk-ZSFULLTW.js";import"./chunk-JBWWZWAU.js";import"./chunk-ITJAHDAK.js";import"./chunk-WVJ73LOB.js";import"./chunk-5WOL6UCU.js";import"./chunk-UCDHUJSY.js";import"./chunk-67JKSNDF.js";import"./chunk-UUSPLNXY.js";import"./chunk-DH7DTWFE.js";import"./chunk-JT567OVO.js";import"./chunk-NY55XGVK.js";import"./chunk-UHVVQU73.js";import{a as Mt,b as Bt}from"./chunk-D2DXDZBG.js";import{a as Ft,b as qt}from"./chunk-67M6C2S2.js";import"./chunk-7JRGKQWZ.js";import{b as xt,c as Vt,y as yt,z as Xt}from"./chunk-WI56WTX3.js";import{Ca as Ct,S as D,_ as dt,aa as ht,c as h,d as ot,da as gt,e as rt,i as at,j as lt,l as ct,la as _t,oa as V,q as mt,s as st,t as ut,u as pt,v as B,xa as ft}from"./chunk-IBFAPW3Z.js";import{$ as p,$a as A,Ca as q,D as x,Da as f,Ea as _,Gb as it,L as k,Lb as Dt,M as S,Ma as Z,Na as tt,Qa as s,Ra as O,V as R,W as j,Y as M,_a as N,ea as H,fa as E,hb as C,ib as et,ka as g,l as T,nb as w,o as G,p as $,qa as v,sa as d,ua as J,v as Nt,va as K,vb as nt,wa as l,xa as r,xb as At,ya as W,z as Q}from"./chunk-S4NGLO4I.js";import"./chunk-OHMQXWFK.js";import"./chunk-IZ5VZLPJ.js";import"./chunk-FTZN4423.js";import"./chunk-R4WQGMAA.js";import"./chunk-5WZLWBAD.js";import"./chunk-UAVZGLFE.js";import"./chunk-3VQMIGUA.js";import"./chunk-GWOLSY5V.js";import"./chunk-QQVLEOUP.js";import"./chunk-HJZG4HTK.js";import"./chunk-XR3M57TO.js";import"./chunk-3FE2HO5M.js";import"./chunk-ZKJSTCFA.js";import{f as L,k as U,m as Y,o as I}from"./chunk-FIPIWZQS.js";function zt(e,o){e&1&&(l(0,"ion-text",14),s(1,"El nombre del titular de la tarjeta es obligatorio"),r())}function Ut(e,o){if(e&1&&g(0,zt,2,0,"ion-text",14),e&2){let n,t=_();d(!((n=t.checkoutForm.get("cardName"))==null||n.errors==null)&&n.errors.required?0:-1)}}function Yt(e,o){e&1&&(l(0,"ion-text",14),s(1,"El n\xFAmero de tarjeta es obligatorio"),r())}function Gt(e,o){e&1&&(l(0,"ion-text",14),s(1,"El n\xFAmero de tarjeta es inv\xE1lido"),r())}function $t(e,o){if(e&1&&g(0,Yt,2,0,"ion-text",14)(1,Gt,2,0,"ion-text",14),e&2){let n,t,i=_();d(!((n=i.checkoutForm.get("cardNumber"))==null||n.errors==null)&&n.errors.required?0:-1),p(),d(!((t=i.checkoutForm.get("cardNumber"))==null||t.errors==null)&&t.errors.pattern?1:-1)}}function Qt(e,o){e&1&&(l(0,"ion-text",14),s(1,"La fecha de caducidad es obligatoria"),r())}function Ht(e,o){if(e&1&&g(0,Qt,2,0,"ion-text",14),e&2){let n,t=_();d(!((n=t.checkoutForm.get("expirationMonth"))==null||n.errors==null)&&n.errors.required||!((n=t.checkoutForm.get("expirationYear"))==null||n.errors==null)&&n.errors.required?0:-1)}}function Jt(e,o){e&1&&(l(0,"ion-text",14),s(1,"El cvc es obligatorio"),r())}function Kt(e,o){if(e&1&&g(0,Jt,2,0,"ion-text",14),e&2){let n,t=_();d(!((n=t.checkoutForm.get("cvc"))==null||n.errors==null)&&n.errors.required?0:-1)}}var X,St=L(()=>{"use strict";w();B();Ct();w();B();X=(()=>{var o,kt;let t=class t{constructor(){U(this,o);this.fb=x(st),this.userFullName=j(""),this.formSubmit=R(),this.submitAttempted=j(!1),this.controlFocus=R()}ngOnInit(){Y(this,o,kt).call(this)}onCardNumberInput(m){var y;let u=m.target,a=u.value.replace(/\D/g,"");a=a.slice(0,16);let c=a.match(/.{1,4}/g);u.value=c?c.join(" - "):a,(y=this.checkoutForm.get("cardNumber"))==null||y.setValue(u.value,{emitEvent:!1})}};o=new WeakSet,kt=function(){this.checkoutForm=this.fb.group({cardName:this.fb.control(this.userFullName(),{validators:[h.required],updateOn:"blur"}),cardNumber:this.fb.control("",{validators:[h.required,h.pattern(/^\d{4} - \d{4} - \d{4} - \d{4}$/)],updateOn:"blur"}),expirationMonth:this.fb.control("",{validators:[h.required,h.minLength(2),h.maxLength(2)],updateOn:"blur"}),expirationYear:this.fb.control("",{validators:[h.required,h.minLength(2),h.maxLength(2)],updateOn:"blur"}),cvc:this.fb.control("",{validators:[h.required,h.minLength(3),h.maxLength(3)],updateOn:"blur"})})},t.\u0275fac=function(u){return new(u||t)},t.\u0275cmp=E({type:t,selectors:[["app-checkout-form"]],inputs:{userFullName:[1,"userFullName"],submitAttempted:[1,"submitAttempted"]},outputs:{formSubmit:"formSubmit",controlFocus:"controlFocus"},decls:27,vars:5,consts:[[3,"formGroup"],[1,"input-wrapper"],["color","light",1,"custom"],["formControlName","cardName","type","text",1,"custom",3,"ionFocus"],["formControlName","cardNumber","type","text","placeholder","XXXX - XXXX - XXXX - XXXX","maxlength","25","inputmode","numeric",1,"custom",3,"ionInput","ionFocus"],[1,"expiration-cvc-row"],[1,"expiration-wrapper"],[1,"expiration-inputs-wrapper"],["formControlName","expirationMonth","placeholder","MM","maxlength","2","inputmode","numeric","type","text",1,"custom","expiration-input",3,"ionFocus"],["formControlName","expirationYear","placeholder","AA","maxlength","2","inputmode","numeric","type","text",1,"custom","expiration-input",3,"ionFocus"],[1,"cvc-wrapper"],["formControlName","cvc","placeholder","XXX","maxlength","3","inputmode","numeric","type","text",1,"custom","cvc-input",3,"ionFocus"],[1,"buttons-container"],["type","button",3,"click"],["color","danger",1,"error-text"]],template:function(u,a){if(u&1&&(l(0,"form",0)(1,"div",1)(2,"ion-label",2),s(3,"Nombre del titular de la tarjeta"),r(),l(4,"ion-input",3),f("ionFocus",function(){return a.controlFocus.emit("cardName")}),r(),g(5,Ut,1,1),r(),l(6,"div",1)(7,"ion-label",2),s(8,"N\xFAmero de tarjeta"),r(),l(9,"ion-input",4),f("ionInput",function(y){return a.onCardNumberInput(y)})("ionFocus",function(){return a.controlFocus.emit("cardNumber")}),r(),g(10,$t,2,2),r(),l(11,"div",5)(12,"div",6)(13,"ion-label",2),s(14,"Fecha de caducidad"),r(),l(15,"div",7)(16,"ion-input",8),f("ionFocus",function(){return a.controlFocus.emit("expiration")}),r(),l(17,"ion-input",9),f("ionFocus",function(){return a.controlFocus.emit("expiration")}),r()(),g(18,Ht,1,1),r(),l(19,"div",10)(20,"ion-label",2),s(21,"CVC"),r(),l(22,"ion-input",11),f("ionFocus",function(){return a.controlFocus.emit("cvc")}),r(),g(23,Kt,1,1),r()()(),l(24,"div",12)(25,"ion-button",13),f("click",function(){return a.formSubmit.emit()}),s(26,"Continuar"),r()()),u&2){let c,y,b,P;v("formGroup",a.checkoutForm),p(5),d(a.submitAttempted()&&((c=a.checkoutForm.get("cardName"))!=null&&c.errors)?5:-1),p(5),d(a.submitAttempted()&&((y=a.checkoutForm.get("cardNumber"))!=null&&y.errors)?10:-1),p(8),d(a.submitAttempted()&&((b=a.checkoutForm.get("expirationMonth"))!=null&&b.errors||(b=a.checkoutForm.get("expirationYear"))!=null&&b.errors)?18:-1),p(5),d(a.submitAttempted()&&((P=a.checkoutForm.get("cvc"))!=null&&P.errors)?23:-1)}},dependencies:[D,V,ft,gt,pt,at,ot,rt,mt,lt,ct],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;flex:1;justify-content:space-between}.expiration-cvc-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:space-between;gap:2rem}.expiration-cvc-row[_ngcontent-%COMP%]   .expiration-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:column}.expiration-cvc-row[_ngcontent-%COMP%]   .expiration-wrapper[_ngcontent-%COMP%]   .expiration-inputs-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:.5rem}.expiration-cvc-row[_ngcontent-%COMP%]   .expiration-wrapper[_ngcontent-%COMP%]   .expiration-inputs-wrapper[_ngcontent-%COMP%]   .expiration-input[_ngcontent-%COMP%]{width:50%;--highlight-color-focused: none;--highlight-color-valid: none;--highlight-color-invalid: none;--highlight-height: 0px}.expiration-cvc-row[_ngcontent-%COMP%]   .cvc-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:column;max-width:4rem}.expiration-cvc-row[_ngcontent-%COMP%]   .cvc-wrapper[_ngcontent-%COMP%]   .cvc-input[_ngcontent-%COMP%]{--highlight-color-focused: none;--highlight-color-valid: none;--highlight-color-invalid: none;--highlight-height: 0px}"]});let e=t;return e})()});var Ot,It=L(()=>{"use strict";w();Lt();Xt();Bt();qt();Nt();Vt();w();Ot=(()=>{let o=class o{constructor(){this.authService=x(yt),this.cartService=x(vt),this.postRepository=x(Ft),this.saleRepository=x(Mt),this.cartItems=C(()=>{var t,i;return(i=(t=this.cartService.cartState())==null?void 0:t.cartItems)!=null?i:[]}),this.cartItemsPosts=xt({request:()=>this.cartItems().map(t=>t.postId),loader:({request:t})=>{var i;if(!t||!t.length)return T([]);try{let m=t.map(u=>{var a;return(a=this.postRepository.getPostById$(u))!=null?a:T(null)});return $(m).pipe(G(u=>u.filter(a=>a!==null)))}catch(m){return this.errorMessage.set((i=m==null?void 0:m.message)!=null?i:"Unknown error"),T([])}}}),this.loading=M(!1),this.errorMessage=M(""),this.checkoutState=C(()=>({cartItems:this.cartItems(),currentUser:this.authService.currentUser(),loading:this.loading(),errorMessage:this.errorMessage()}))}checkout(t){return I(this,null,function*(){var i,m,u,a;this.loading.set(!0),yield new Promise(c=>setTimeout(c,1e3));try{let c=this.authService.currentUser(),y=new Date,b=[];for(let P of this.cartItems()){let z,F=(i=this.cartItemsPosts.value())==null?void 0:i.find(Et=>Et._id===P.postId);if(!F)return null;if(!F.isActive)throw new Error("Post is inactive");let Tt={postData:{postId:P.postId,title:P.title,articleCondition:F.article.condition,price:P.price,mainImageURL:F.mainImageURL},buyerData:{userId:(m=c==null?void 0:c._id)!=null?m:"",username:(u=c==null?void 0:c.username)!=null?u:"",profilePictureURL:(a=c==null?void 0:c.profilePictureURL)!=null?a:""},sellerData:{userId:F.user.userId,username:F.user.username,profilePictureURL:F.user.profilePictureURL},paymentData:{cardName:t.paymentData.cardName,cardNumber:t.paymentData.cardNumber,expirationMonth:t.paymentData.expirationMonth,expirationYear:t.paymentData.expirationYear,cvc:t.paymentData.cvc},saleDate:y};(z=yield this.saleRepository.saveSale(Tt))&&b.push(z)}return this.loading.set(!1),b}catch(c){return console.error(c),null}})}};o.\u0275fac=function(i){return new(i||o)},o.\u0275prov=Q({token:o,factory:o.\u0275fac,providedIn:"root"});let e=o;return e})()});function Zt(e,o){if(e&1){let n=q();l(0,"div",4)(1,"ion-text",5),s(2,"Datos de pago"),r(),l(3,"app-checkout-form",6),f("nextStep",function(){k(n);let i=_();return S(i.nextStep())})("controlFocus",function(i){k(n);let m=_();return S(m.onControlFocus(i))})("formSubmit",function(){k(n);let i=_();return S(i.handleFormSubmit())}),r()()}if(e&2){let n=_();p(3),v("userFullName",n.userFullName())("submitAttempted",n.submitAttempted())}}function te(e,o){if(e&1&&(l(0,"ion-text",11)(1,"ion-text",21),s(2),r(),l(3,"ion-text",22),s(4),N(5,"formatCurrency"),r()()),e&2){let n=o.$implicit;p(2),O(n.title),p(2),O(A(5,2,n.price))}}function ee(e,o){e&1&&W(0,"ion-spinner",20)}function ne(e,o){if(e&1){let n=q();l(0,"div",7)(1,"ion-text",8),s(2,"Resumen"),r(),l(3,"div",9)(4,"div",10),J(5,te,6,4,"ion-text",11,Wt),r(),l(7,"div",12)(8,"ion-text",13),s(9,"Env\xEDo"),r(),l(10,"ion-text",14),s(11),N(12,"formatCurrency"),r()(),l(13,"div",15)(14,"ion-text",16),s(15,"Total"),r(),l(16,"ion-text",17),s(17),N(18,"formatCurrency"),r()()()(),l(19,"div",18)(20,"ion-button",19),f("click",function(){k(n);let i=_();return S(i.handleCheckout())}),s(21," Pagar "),g(22,ee,1,0,"ion-spinner",20),r()()}if(e&2){let n=_();p(5),K(n.cartItems()),p(6),O(A(12,4,n.itemsShippingTotal())),p(6),O(A(18,6,n.totalPrice())),p(3),v("disabled",n.loading()),p(2),d(n.loading()?22:-1)}}var Wt,Ne,ie=L(()=>{w();At();B();Ct();Rt();St();It();jt();Dt();w();Wt=(e,o)=>o.postId;Ne=(()=>{let o=class o{constructor(){this.router=x(it),this.checkoutService=x(Ot),this.step=M(1),this.totalSteps=2,this.progressBarValue=C(()=>this.step()/this.totalSteps),this.checkoutFormComponent=H(X),this.checkoutFormData=M({}),this.submitAttempted=M(!1),this.loading=C(()=>this.checkoutService.checkoutState().loading),this.userFullName=C(()=>{var t;return(t=this.checkoutService.checkoutState().currentUser.fullName)!=null?t:""}),this.cartItems=C(()=>{var t;return(t=this.checkoutService.checkoutState().cartItems)!=null?t:[]}),this.itemsArticlesTotal=C(()=>this.cartItems().reduce((t,i)=>t+i.price,0)),this.itemsShippingTotal=C(()=>this.cartItems().reduce((t,i)=>t+i.shipping,0)),this.totalPrice=C(()=>this.itemsArticlesTotal()+this.itemsShippingTotal()),et(()=>console.log({loading:this.loading()}))}ngOnInit(){}nextStep(){this.step.set(this.step()+1)}prevStep(){this.step.set(1)}onControlFocus(t){this.submitAttempted.set(!1)}handleFormSubmit(){var t,i,m,u;this.submitAttempted.set(!0),!((i=(t=this.checkoutFormComponent())==null?void 0:t.checkoutForm)!=null&&i.invalid)&&(this.checkoutFormData.set((u=(m=this.checkoutFormComponent())==null?void 0:m.checkoutForm)==null?void 0:u.value),this.nextStep())}handleCheckout(){return I(this,null,function*(){try{yield this.checkoutService.checkout({items:this.cartItems(),paymentData:this.checkoutFormData()}),this.router.navigate(["/checkout/splash"])}catch(t){console.error(t)}})}};o.\u0275fac=function(i){return new(i||o)},o.\u0275cmp=E({type:o,selectors:[["app-payment"]],viewQuery:function(i,m){i&1&&Z(m.checkoutFormComponent,X,5),i&2&&tt()},decls:6,vars:8,consts:[[3,"translucent"],["type","arrow-back","title","Pagar",3,"backPressed","showSearch","showProgressBar","progressBarValue","backActionType"],[3,"fullscreen"],[1,"container"],[1,"payment"],[1,"payment-label"],[3,"nextStep","controlFocus","formSubmit","userFullName","submitAttempted"],[1,"summary"],[1,"summary-label"],[1,"summary-content"],[1,"summary-items-rows"],[1,"summary-row","item-row"],[1,"summary-row","shipping-row"],[1,"shipping-label"],[1,"shipping-price"],[1,"summary-row","total-row"],[1,"total-label"],[1,"total-price"],[1,"buttons-container"],[1,"custom",3,"click","disabled"],["name","crescent"],[1,"item-title"],[1,"item-price"]],template:function(i,m){i&1&&(l(0,"ion-header",0)(1,"app-toolbar",1),f("backPressed",function(){return m.prevStep()}),r()(),l(2,"ion-content",2)(3,"div",3),g(4,Zt,4,2,"div",4)(5,ne,23,8),r()()),i&2&&(v("translucent",!0),p(),v("showSearch",!1)("showProgressBar",!0)("progressBarValue",m.progressBarValue())("backActionType",m.step()===1?"default":"emit"),p(),v("fullscreen",!0),p(2),d(m.step()===1?4:-1),p(),d(m.step()===2?5:-1))},dependencies:[_t,bt,X,D,V,dt,ht,nt,ut,Pt],styles:[".container[_ngcontent-%COMP%]{min-height:100%;display:flex;flex-direction:column;flex:1;justify-content:space-between}.container[_ngcontent-%COMP%]   .payment[_ngcontent-%COMP%]{padding-top:1.5rem;display:flex;flex-direction:column;flex:1 0 0}.container[_ngcontent-%COMP%]   .payment[_ngcontent-%COMP%]   .payment-label[_ngcontent-%COMP%]{font-family:Montserrat;font-size:var(--headline-small-size, 1.5rem);font-style:normal;font-weight:var(--headline-small-weight, 400);line-height:var(--headline-small-line-height, 2rem);letter-spacing:var(--headline-small-tracking, 0rem);margin-bottom:1.5rem}.container[_ngcontent-%COMP%]   .summary[_ngcontent-%COMP%]{padding-top:1.5rem;display:flex;flex-direction:column;gap:1rem;flex:1 0 0}.container[_ngcontent-%COMP%]   .summary[_ngcontent-%COMP%]   .summary-label[_ngcontent-%COMP%]{font-family:Montserrat;font-size:var(--headline-small-size, 1.5rem);font-style:normal;font-weight:var(--headline-small-weight, 400);line-height:var(--headline-small-line-height, 2rem);letter-spacing:var(--headline-small-tracking, 0rem);margin-bottom:1.5rem}.container[_ngcontent-%COMP%]   .summary[_ngcontent-%COMP%]   .summary-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem}.container[_ngcontent-%COMP%]   .summary[_ngcontent-%COMP%]   .summary-content[_ngcontent-%COMP%]   .summary-row[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:space-between;align-items:flex-end}.container[_ngcontent-%COMP%]   .summary[_ngcontent-%COMP%]   .summary-content[_ngcontent-%COMP%]   .summary-items-rows[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.container[_ngcontent-%COMP%]   .summary[_ngcontent-%COMP%]   .summary-content[_ngcontent-%COMP%]   .summary-items-rows[_ngcontent-%COMP%]   .item-row[_ngcontent-%COMP%]{font-size:var(--body-large-size, 1rem);font-style:normal;font-weight:400;line-height:var(--body-large-line-height, 1.5rem);letter-spacing:var(--body-large-tracking, .03125rem);padding:.2rem 0;border-bottom:1px solid var(--ion-color-medium-tint)}.container[_ngcontent-%COMP%]   .summary[_ngcontent-%COMP%]   .summary-content[_ngcontent-%COMP%]   .summary-items-rows[_ngcontent-%COMP%]   .item-row[_ngcontent-%COMP%]   .item-title[_ngcontent-%COMP%]{max-width:65%}.container[_ngcontent-%COMP%]   .summary[_ngcontent-%COMP%]   .summary-content[_ngcontent-%COMP%]   .summary-items-rows[_ngcontent-%COMP%]   .item-row[_ngcontent-%COMP%]   .item-price[_ngcontent-%COMP%]{max-width:35%}.container[_ngcontent-%COMP%]   .summary[_ngcontent-%COMP%]   .summary-content[_ngcontent-%COMP%]   .shipping-row[_ngcontent-%COMP%]{margin-top:1rem;font-size:var(--body-medium-size, .875rem);font-style:normal;font-weight:var(--body-medium-weight, 400);line-height:var(--body-medium-line-height, 1.25rem);letter-spacing:var(--body-medium-tracking, .01563rem)}.container[_ngcontent-%COMP%]   .summary[_ngcontent-%COMP%]   .summary-content[_ngcontent-%COMP%]   .total-row[_ngcontent-%COMP%]{font-size:var(--label-larger-size, 1.25rem);font-style:normal;font-weight:var(--label-larger-weight-prominent, 600);line-height:var(--label-larger-line-height, 1.625rem);letter-spacing:var(--label-larger-tracking, 0rem)}"]});let e=o;return e})()});ie();export{Ne as PaymentPage};
