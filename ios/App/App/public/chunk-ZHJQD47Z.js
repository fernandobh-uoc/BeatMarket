import{c as M,d as J}from"./chunk-OWPIXBBY.js";import{a as T,d as K}from"./chunk-CC7RULIL.js";import{a as k,b as O}from"./chunk-ATV22YZD.js";import{a as N,b as q,r as S,s as z,t as _,u as G,v as j,w as H}from"./chunk-GIZGGZ62.js";import{B as D,F as U,_ as A,pb as E}from"./chunk-LBGYGD76.js";import{f as C,j as c,k as u,l as h,o as s}from"./chunk-FIPIWZQS.js";function x(f){if(typeof f!="string")return null;let d=f.replace(/[^\d,.-]/g,"").replace(/\./g,"").replace(",","."),n=parseFloat(d);return isNaN(n)?null:n}var B=C(()=>{"use strict"});var ot,Q=C(()=>{"use strict";E();O();J();G();H();q();K();z();B();E();ot=(()=>{var d,n,R,I,y,b,v;let p=class p{constructor(){u(this,d);u(this,n);u(this,R);u(this,I);u(this,y);u(this,b);u(this,v);h(this,d,U(j)),h(this,n,U(k)),h(this,R,U(N)),h(this,I,U(S)),this.imagesDataURLs=A([]),this.latestPublishedPostId=A(""),h(this,y,A("")),this.loadImages=()=>s(this,null,function*(){let e=yield M.pickImages({quality:80,limit:10}),t=yield Promise.all(e.photos.map(g=>s(this,null,function*(){let i=yield(yield fetch(g.webPath)).blob();return yield c(this,b).call(this,i)})));return this.imagesDataURLs.set(t),this.imagesDataURLs()}),this.loadImagesNotNative=e=>s(this,null,function*(){let t=e.target;if(!t.files)return;let a=Array.from(t.files).map(i=>s(this,null,function*(){return new Promise((o,P)=>{let l=new FileReader;l.onload=()=>{let w=l.result;o(w)},l.onerror=()=>{P(new Error("Error al leer el archivo"))},l.readAsDataURL(i)})}));try{let i=yield Promise.all(a);this.imagesDataURLs.set(i)}catch(i){console.error(i)}}),this.removeImages=()=>s(this,null,function*(){this.imagesDataURLs.set([])}),this.publishPost=e=>s(this,null,function*(){var g,a,i,o,P,l,w,L;let t=c(this,d).currentUser();if(t)try{let r=yield c(this,n).savePost({title:e.title,description:e.description,user:{userId:(g=t==null?void 0:t._id)!=null?g:"",username:(a=t==null?void 0:t.username)!=null?a:"",profilePictureURL:(i=t==null?void 0:t.profilePictureURL)!=null?i:""},price:typeof e.price=="number"?e.price:x(e.price),isActive:!0,finishedAt:null,article:{category:e.category,condition:e.condition,characteristics:e.characteristics}});if(!r)return;let m=yield c(this,v).call(this,r._id);yield c(this,n).updatePost({_id:r._id,mainImageURL:(o=m==null?void 0:m[0])!=null?o:"",imagesURLs:m!=null?m:[]});let $={_id:r._id,title:(P=r==null?void 0:r.title)!=null?P:"",category:(l=r==null?void 0:r.article.category)!=null?l:T.None,price:(w=r==null?void 0:r.price)!=null?w:0,mainImageURL:(L=m==null?void 0:m[0])!=null?L:""};yield c(this,R).saveActivePost({userId:t._id,activePostData:$}),this.latestPublishedPostId.set(r._id)}catch(r){console.error(r),c(this,y).set(r)}}),h(this,b,e=>s(this,null,function*(){return new Promise((t,g)=>{let a=new FileReader;a.onloadend=()=>t(a.result),a.onerror=g,a.readAsDataURL(e)})})),h(this,v,(g,...a)=>s(this,[g,...a],function*(e,t=this.imagesDataURLs()){let i=t.map((o,P)=>s(this,null,function*(){return new Promise((l,w)=>s(this,null,function*(){let L=yield c(this,I).upload(`postImages/${e}/image_${P}`,_(o));L&&l(L),w(new Error("Error uploading image to cloud storage"))}))}));try{return yield Promise.all(i)}catch(o){throw console.error(o),o}}))}get errorMessage(){return c(this,y).asReadonly()}};d=new WeakMap,n=new WeakMap,R=new WeakMap,I=new WeakMap,y=new WeakMap,b=new WeakMap,v=new WeakMap,p.\u0275fac=function(t){return new(t||p)},p.\u0275prov=D({token:p,factory:p.\u0275fac,providedIn:"root"});let f=p;return f})()});export{ot as a,Q as b};
