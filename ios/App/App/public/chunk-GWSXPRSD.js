import{c as M,d as q}from"./chunk-3LZDXMQH.js";import{a as E,d as z}from"./chunk-CC7RULIL.js";import{a as N,b as G}from"./chunk-67M6C2S2.js";import{f as A,g as k,u as S,v as x,w as D,x as B,y as C,z as $}from"./chunk-WI56WTX3.js";import{D as y,Y as P,hb as L,nb as U,z as v}from"./chunk-S4NGLO4I.js";import{f as b,j as R,k as w,l as I,o as i}from"./chunk-FIPIWZQS.js";function _(u){if(typeof u!="string")return null;let h=u.replace(/[^\d,.-]/g,"").replace(/\./g,"").replace(",","."),l=parseFloat(h);return isNaN(l)?null:l}var j=b(()=>{"use strict"});var st,H=b(()=>{"use strict";U();G();q();B();$();k();z();x();j();U();st=(()=>{var h,l;let m=class m{constructor(){w(this,h);w(this,l);this.authService=y(C),this.postRepository=y(N),this.userRepository=y(A),this.cloudStorage=y(S),this.imagesDataURLs=P([]),this.latestPublishedPostId=P(""),this.loading=P(!1),this.errorMessage=P(""),this.sellState=L(()=>({imagesDataURLs:this.imagesDataURLs(),latestPublishedPostId:this.latestPublishedPostId(),loading:this.loading(),errorMessage:this.errorMessage()})),this.loadImages=()=>i(this,null,function*(){let e=yield M.pickImages({quality:80,limit:10}),t=yield Promise.all(e.photos.map(d=>i(this,null,function*(){let r=yield(yield fetch(d.webPath)).blob();return yield R(this,h).call(this,r)})));return this.imagesDataURLs.set(t),this.imagesDataURLs()}),this.loadImagesNotNative=e=>i(this,null,function*(){let t=e.target;if(!t.files)return;let a=Array.from(t.files).map(r=>i(this,null,function*(){return new Promise((o,g)=>{let c=new FileReader;c.onload=()=>{let p=c.result;o(p)},c.onerror=()=>{g(new Error("Error al leer el archivo"))},c.readAsDataURL(r)})}));try{let r=yield Promise.all(a);this.imagesDataURLs.set(r)}catch(r){console.error(r)}}),this.removeImages=()=>i(this,null,function*(){this.imagesDataURLs.set([])}),this.publishPost=e=>i(this,null,function*(){var d,a,r,o,g,c,p,f;let t=this.authService.currentUser();if(t){this.loading.set(!0);try{let s=yield this.postRepository.savePost({title:e.title,description:e.description,user:{userId:(d=t==null?void 0:t._id)!=null?d:"",username:(a=t==null?void 0:t.username)!=null?a:"",profilePictureURL:(r=t==null?void 0:t.profilePictureURL)!=null?r:""},price:typeof e.price=="number"?e.price:_(e.price),isActive:!0,finishedAt:null,article:{category:e.category,condition:e.condition,characteristics:e.characteristics}});if(!s)return;let n=yield R(this,l).call(this,s._id);yield this.postRepository.updatePost({_id:s._id,mainImageURL:(o=n==null?void 0:n[0])!=null?o:"",imagesURLs:n!=null?n:[]});let T={_id:s._id,title:(g=s==null?void 0:s.title)!=null?g:"",category:(c=s==null?void 0:s.article.category)!=null?c:E.None,price:(p=s==null?void 0:s.price)!=null?p:0,mainImageURL:(f=n==null?void 0:n[0])!=null?f:""};yield this.userRepository.saveActivePost({userId:t._id,activePostData:T}),this.latestPublishedPostId.set(s._id),this.loading.set(!1),this.errorMessage.set("")}catch(s){console.error(s),this.loading.set(!1),this.errorMessage.set(s)}}}),I(this,h,e=>i(this,null,function*(){return new Promise((t,d)=>{let a=new FileReader;a.onloadend=()=>t(a.result),a.onerror=d,a.readAsDataURL(e)})})),I(this,l,(d,...a)=>i(this,[d,...a],function*(e,t=this.imagesDataURLs()){let r=t.map((o,g)=>i(this,null,function*(){return new Promise((c,p)=>i(this,null,function*(){let f=yield this.cloudStorage.upload(`postImages/${e}/image_${g}`,D(o));f&&c(f),p(new Error("Error uploading image to cloud storage"))}))}));try{return yield Promise.all(r)}catch(o){throw console.error(o),o}}))}};h=new WeakMap,l=new WeakMap,m.\u0275fac=function(t){return new(t||m)},m.\u0275prov=v({token:m,factory:m.\u0275fac,providedIn:"root"});let u=m;return u})()});export{st as a,H as b};
