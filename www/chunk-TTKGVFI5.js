import{a as g,b as S}from"./chunk-PIDRDD2T.js";import{b as I,c as R,t as m,u as b}from"./chunk-VQCHUAXV.js";import{D as v,Y as h,hb as y,l as i,nb as f,v as w,z as p}from"./chunk-DHHGUDQP.js";import{f as C,o as c}from"./chunk-FIPIWZQS.js";var P,M=C(()=>{"use strict";f();R();w();S();b();f();P=(()=>{let s=class s{constructor(){this.conversationRepository=v(g),this.authService=v(m),this.conversationId=h(void 0),this.errorMessage=h(""),this.conversation=I({request:()=>this.conversationId(),loader:({request:e})=>{var r;if(!this.conversationRepository.getConversationById$)return i(null);if(!e)return i(null);try{let t=this.conversationRepository.getConversationById$(e);return t!=null?t:i(null)}catch(t){return this.errorMessage.set((r=t==null?void 0:t.message)!=null?r:"Unknown error"),i(null)}}}),this.conversationState=y(()=>{var e,r,t;return{conversation:(e=this.conversation.value())!=null?e:null,loading:this.conversation.isLoading(),role:((r=this.conversation.value())==null?void 0:r.participants.buyer.userId)===((t=this.authService.currentUser())==null?void 0:t._id)?"buyer":"seller",errorMessage:this.errorMessage()}})}reloadConversationResource(){this.conversation.reload()}setConversationId(e){this.conversationId.set(e)}getConversationId(r){return c(this,arguments,function*({postId:e}){var t;try{let a=(t=yield this.conversationRepository.getConversationsByPostId(e))!=null?t:[];if(a.length>0){let o=a.find(n=>{var d;let l=(d=this.authService.currentUser())==null?void 0:d._id;return n.participants.buyer.userId===l||n.participants.seller.userId===l});if(o)return o._id}return null}catch(a){throw a}})}createConversation(a){return c(this,arguments,function*({relatedPostData:e,buyerData:r,sellerData:t}){try{let o={relatedPost:e,participants:{buyer:r,seller:t}},n=yield this.conversationRepository.saveConversation(o);return n?n._id:null}catch(o){throw o}})}sendMessage(e){return c(this,null,function*(){var t;let r=this.conversationState().conversation;r&&(yield this.conversationRepository.saveMessage({conversationId:r._id,messageData:{text:e,timestamp:new Date,senderId:(t=this.authService.currentUser())==null?void 0:t._id,recipientId:r.participants[this.conversationState().role==="buyer"?"seller":"buyer"].userId}}))})}};s.\u0275fac=function(r){return new(r||s)},s.\u0275prov=p({token:s,factory:s.\u0275fac,providedIn:"root"});let u=s;return u})()});export{P as a,M as b};
